<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.futurenet.sorisoopbackend.subscription.domain.SubscriptionRepository">

    <select id="getSubscriptionByMemberId"
            parameterType="long"
            resultType="com.futurenet.sorisoopbackend.subscription.domain.Subscription">
        SELECT S.ID                   AS id,
               S.MEMBER_ID            AS memberId,
               S.SUBSCRIPTION_PLAN_ID AS subscriptionPlanId,
               S.STATUS               AS status,
               S.STARTED_AT           AS startedAt,
               S.NEXT_BILLING_AT      AS nextBillingAt,
               S.CANCELLED_AT         AS cancelledAt,
               S.LAST_APPROVED_AT     AS lastApprovedAt,
               S.CREATED_AT           AS createdAt,
               S.UPDATED_AT           AS updatedAt,
               S.CREATED_BY           AS createdBy,
               S.UPDATED_BY           AS updatedBy
        FROM SUBSCRIPTION S
        WHERE S.MEMBER_ID = #{memberId}
    </select>


    <select id="getSubscriptionPlans" resultType="com.futurenet.sorisoopbackend.subscription.domain.SubscriptionPlan">
        SELECT ID, TYPE, PRICE
        FROM SUBSCRIPTION_PLAN
    </select>

    <select id="getSubscriptionPlanByType"
            parameterType="string"
            resultType="com.futurenet.sorisoopbackend.subscription.domain.SubscriptionPlan">
        SELECT ID,
               TYPE,
               PRICE
        FROM SUBSCRIPTION_PLAN
        WHERE TYPE = #{planType}
    </select>

    <select id="getSubscriptionPlanById"
            parameterType="long"
            resultType="com.futurenet.sorisoopbackend.subscription.domain.SubscriptionPlan">
        SELECT ID,
               TYPE,
               PRICE
        FROM SUBSCRIPTION_PLAN
        WHERE ID = #{planId}
    </select>

    <insert id="insertSubscription"
            parameterType="com.futurenet.sorisoopbackend.subscription.domain.Subscription"
            useGeneratedKeys="true" keyProperty="id" keyColumn="ID">
        INSERT INTO SUBSCRIPTION (MEMBER_ID,
                                  SUBSCRIPTION_PLAN_ID,
                                  STATUS,
                                  STARTED_AT,
                                  NEXT_BILLING_AT,
                                  LAST_APPROVED_AT,
                                  CREATED_AT,
                                  CREATED_BY)
        VALUES (#{memberId},
                #{subscriptionPlanId},
                #{status},
                #{startedAt},
                #{nextBillingAt},
                #{lastApprovedAt},
                #{createdAt},
                #{createdBy})
    </insert>

    <update id="cancelSubscription" parameterType="long">
        UPDATE SUBSCRIPTION
        SET STATUS       = 'CANCELLED',
            CANCELLED_AT = NEXT_BILLING_AT,
            UPDATED_AT   = SYSDATE,
            UPDATED_BY   = #{memberId}
        WHERE MEMBER_ID = #{memberId}
          AND STATUS = 'ACTIVE'
    </update>

    <update id="updateSubscriptionStatus">
        UPDATE SUBSCRIPTION
        SET STATUS     = #{status},
            UPDATED_AT = SYSDATE,
            UPDATED_BY = #{updatedBy}
        WHERE ID = #{subscriptionId}
    </update>

    <insert id="insertCustomerToken">
        INSERT INTO BRAND_PAY_TOKEN (MEMBER_ID, CUSTOMER_TOKEN, REFRESH_TOKEN, EXPIRES_AT, CREATED_AT)
        VALUES (#{memberId},
                #{token.accessToken},
                #{token.refreshToken},
                #{token.expiresAt},
                SYSDATE)
    </insert>

    <update id="updateCustomerToken">
        UPDATE BRAND_PAY_TOKEN
        SET CUSTOMER_TOKEN = #{token.accessToken},
            REFRESH_TOKEN  = #{token.refreshToken},
            EXPIRES_AT     = #{token.expiresAt}
        WHERE MEMBER_ID = #{memberId}
    </update>

    <select id="existsCustomerToken" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM BRAND_PAY_TOKEN
        WHERE MEMBER_ID = #{memberId}
    </select>

</mapper>

